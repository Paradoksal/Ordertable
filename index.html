<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordreoversikt</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Ordreoversikt</h1>

    <!-- Tema-bytte knapp -->
    <button id="theme-toggle">Bytt til mørkt tema</button>

    <div id="total-orders">
        Totalt fullførte ordre
        <div class="order-stats">
            I dag: <span id="today" class="number">Laster...</span>
            Denne uken: <span id="week" class="number">Laster...</span>
            Denne måneden: <span id="month" class="number">Laster...</span>
            I år: <span id="year" class="number">Laster...</span>
        </div>
    </div>
    
    <div id="remaining-orders">
        Gjenstående ordre å fullføre i dag: <span id="remaining-total" class="highlight">Laster...</span>
    </div>

    <table id="data-table">
        <thead>
            <tr>
                <th data-sort="string">Vareeier</th>
                <th data-sort="number">AutoStore Ordre</th>
                <th data-sort="number">Delvis Plukket Ordre</th>
                <th data-sort="number">Manuelt Plukk Ordre</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data vil bli fylt inn her -->
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td><strong>Totalt</strong></td>
                <td id="total-autostore">0</td>
                <td id="total-delvis-plukket">0</td>
                <td id="total-manuelt-plukk">0</td>
            </tr>
        </tfoot>
    </table>

    <script>
        // Globale variabler for sorteringsinnstillinger
        let currentSortColumnIndex = 0; // Lagre indeksen til den nåværende sorteringskolonnen
        let currentSortOrder = true; // true for stigende, false for synkende

        // Hent og sett tema fra localStorage
        const theme = localStorage.getItem('theme') || 'light';
        document.body.classList.toggle('dark', theme === 'dark');
        document.getElementById('theme-toggle').textContent = theme === 'dark' ? 'Bytt til Lyst Tema' : 'Bytt til Mørkt Tema';

        // Bytte mellom mørkt og lyst tema
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').textContent = isDark ? 'Bytt til Lyst Tema' : 'Bytt til Mørkt Tema';
        });

        // Hent data ved først lasting av siden og deretter hvert minutt
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setInterval(fetchData, 60000);

            // Legg til sorteringsfunksjonalitet på tabellkolonner
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const order = header.dataset.sort;
                    currentSortOrder = !header.classList.contains('sorted-asc');
                    currentSortColumnIndex = index;
                    sortTable(index, order, currentSortOrder);
                    headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                    header.classList.add(currentSortOrder ? 'sorted-asc' : 'sorted-desc');
                });
            });
        });

        // Hent data fra server
        async function fetchData() {
            try {
                const response = await fetch('https://node-red.cloudflareno.de/getOrderData');
                if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
                const data = await response.json();
                updateTable(data.tabellData);
                updateStats(data.fullforteOrdre);
                updateRemainingOrders(data.tabellData);

                // Sorter tabellen etter oppdatering
                const headers = document.querySelectorAll('#data-table th');
                sortTable(currentSortColumnIndex, headers[currentSortColumnIndex].dataset.sort, currentSortOrder);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.querySelector('#total-orders').textContent = 'Kunne ikke laste data.';
                document.querySelector('#remaining-orders').textContent = 'Kunne ikke laste data.';
            }
        }

        // Formatere tall med mellomrom som tusenskiller
        function formatNumber(number) {
            return number.toLocaleString('no-NO').replace(/,/g, ' ');
        }

        // Oppdater tabellen med data
        function updateTable(tabellData) {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';
            let totalAutostore = 0, totalDelvisPlukket = 0, totalManueltPlukk = 0;

            for (const [vareeier, ordre] of Object.entries(tabellData)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vareeier}</td>
                    <td>${formatNumber(parseInt(ordre.autostore) || 0) || ''}</td>
                    <td>${formatNumber(parseInt(ordre.delvisPlukket) || 0) || ''}</td>
                    <td>${formatNumber(parseInt(ordre.manueltPlukk) || 0) || ''}</td>
                `;
                tableBody.appendChild(row);
                totalAutostore += parseInt(ordre.autostore) || 0;
                totalDelvisPlukket += parseInt(ordre.delvisPlukket) || 0;
                totalManueltPlukk += parseInt(ordre.manueltPlukk) || 0;
            }

            // Oppdater totaler i tabellens bunn
            document.getElementById('total-autostore').textContent = totalAutostore > 0 ? formatNumber(totalAutostore) : '';
            document.getElementById('total-delvis-plukket').textContent = totalDelvisPlukket > 0 ? formatNumber(totalDelvisPlukket) : '';
            document.getElementById('total-manuelt-plukk').textContent = totalManueltPlukk > 0 ? formatNumber(totalManueltPlukk) : '';
        }

        // Oppdater statistikk-seksjonen
        function updateStats(fullforteOrdre) {
            document.getElementById('today').textContent = formatNumber(fullforteOrdre.iDag || '0');
            document.getElementById('week').textContent = formatNumber(fullforteOrdre.denneUken || '0');
            document.getElementById('month').textContent = formatNumber(fullforteOrdre.denneManeden || '0');
            document.getElementById('year').textContent = formatNumber(fullforteOrdre.iAr || '0');
        }

        // Oppdater gjenstående ordre
        function updateRemainingOrders(tabellData) {
            let totalRemaining = 0;
            for (const ordre of Object.values(tabellData)) {
                totalRemaining += parseInt(ordre.autostore) || 0;
                totalRemaining += parseInt(ordre.delvisPlukket) || 0;
                totalRemaining += parseInt(ordre.manueltPlukk) || 0;
            }
            document.querySelector('#remaining-total').textContent = formatNumber(totalRemaining);
        }

        // Sorter tabellen etter kolonne
        function sortTable(columnIndex, type, ascending) {
            const table = document.querySelector('#data-table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));

            const compare = (a, b) => {
                const aText = a.children[columnIndex].textContent.trim();
                const bText = b.children[columnIndex].textContent.trim();
                if (type === 'number') {
                    return (parseFloat(aText.replace(/\s/g, '')) - parseFloat(bText.replace(/\s/g, ''))) * (ascending ? 1 : -1);
                }
                return aText.localeCompare(bText) * (ascending ? 1 : -1);
            };

            rows.sort(compare);
            table.querySelector('tbody').append(...rows);
        }
    </script>
</body>
</html>
