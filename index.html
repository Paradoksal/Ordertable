<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordreoversikt</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Ordreoversikt</h1>

    <!-- Tema-bytte knapp -->
    <button id="theme-toggle">Bytt til Mørkt Tema</button>

    <div id="total-orders">
        Totalt fullførte ordre:
        <div class="order-stats">
            I dag: <span id="today" class="number">Laster...</span>
            Denne Uken: <span id="week" class="number">Laster...</span>
            Denne Måneden: <span id="month" class="number">Laster...</span>
            I År: <span id="year" class="number">Laster...</span>
        </div>
    </div>
    
    <div id="remaining-orders">
        Gjenstående ordre å fullføre i dag: <span id="remaining-total" class="highlight">Laster...</span>
    </div>

    <table id="data-table">
        <thead>
            <tr>
                <th data-sort="string">Vareeier</th>
                <th data-sort="number">AutoStore Ordre</th>
                <th data-sort="number">Delvis Plukket Ordre</th>
                <th data-sort="number">Manuelt Plukk Ordre</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data vil bli fylt inn her -->
        </tbody>
    </table>

    <script>
        // Bytte mellom mørkt og lyst tema
        const themeToggleButton = document.getElementById('theme-toggle');
        const body = document.body;

        themeToggleButton.addEventListener('click', () => {
            body.classList.toggle('dark');

            if (body.classList.contains('dark')) {
                themeToggleButton.textContent = 'Bytt til Lyst Tema';
            } else {
                themeToggleButton.textContent = 'Bytt til Mørkt Tema';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchData(); // Hent data ved først lasting av siden
            setInterval(fetchData, 60000); // Hent data hver 60.000 millisekund (60 sekunder)

            // Legge til sorteringsfunksjonalitet
            const table = document.querySelector('#data-table');
            const headers = table.querySelectorAll('th');
            
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const order = header.dataset.sort;
                    const isAscending = header.classList.contains('sorted-asc');
                    
                    sortTable(index, order, !isAscending);
                    
                    headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                    header.classList.add(isAscending ? 'sorted-desc' : 'sorted-asc');
                });
            });
        });

        async function fetchData() {
            try {
                const response = await fetch('https://node-red.cloudflareno.de/getOrderData');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const data = await response.json();

                updateTable(data.tabellData);
                updateStats(data.fullforteOrdre);
                updateRemainingOrders(data.tabellData);

                // Sorter tabellen etter oppdatering (kan velge hvilken kolonne og rekkefølge)
                const firstHeader = document.querySelector('#data-table th');
                sortTable(0, firstHeader.dataset.sort, true);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.querySelector('#total-orders').innerHTML = 'Kunne ikke laste data.';
                document.querySelector('#remaining-orders').innerHTML = 'Kunne ikke laste data.';
            }
        }

        function updateTable(tabellData) {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';

            for (const [vareeier, ordre] of Object.entries(tabellData)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vareeier}</td>
                    <td>${ordre.autostore}</td>
                    <td>${ordre.delvisPlukket}</td>
                    <td>${ordre.manueltPlukk}</td>
                `;
                tableBody.appendChild(row);
            }
        }

        function updateStats(fullforteOrdre) {
            document.getElementById('today').textContent = fullforteOrdre.iDag || '0';
            document.getElementById('week').textContent = fullforteOrdre.denneUken || '0';
            document.getElementById('month').textContent = fullforteOrdre.denneManeden || '0';
            document.getElementById('year').textContent = fullforteOrdre.iAr || '0';
        }

        function updateRemainingOrders(tabellData) {
            let totalRemaining = 0;

            for (const ordre of Object.values(tabellData)) {
                totalRemaining += parseInt(ordre.autostore) || 0;
                totalRemaining += parseInt(ordre.delvisPlukket) || 0;
                totalRemaining += parseInt(ordre.manueltPlukk) || 0;
            }

            document.querySelector('#remaining-total').textContent = totalRemaining;
        }

        function sortTable(columnIndex, type, ascending) {
            const table = document.querySelector('#data-table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const compare = (a, b) => {
                const aText = a.children[columnIndex].textContent.trim();
                const bText = b.children[columnIndex].textContent.trim();

                if (type === 'number') {
                    return (parseFloat(aText) - parseFloat(bText)) * (ascending ? 1 : -1);
                }
                return aText.localeCompare(bText) * (ascending ? 1 : -1);
            };

            rows.sort(compare);
            table.querySelector('tbody').append(...rows);
        }
    </script>
</body>
</html>
